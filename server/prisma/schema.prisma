// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id        String     @id @default(cuid())
  email     String     @unique
  name      String
  password  String     // Will be hashed with bcrypt
  avatar    String?
  role      UserRole   @default(MEMBER)
  
  // Relations
  workspacesOwned   Workspace[]
  workspaces       WorkspaceUser[]
  projectsLed      Project[]      @relation("ProjectLead")
  projects         ProjectUser[]
  tasksAssigned    Task[]         @relation("TaskAssignee")
  filesUploaded    FileAsset[]    @relation("FileUploader")
  comments         Comment[]
  
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Workspace {
  id        String     @id @default(cuid())
  name      String
  ownerId   String
  owner     User       @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  
  // Relations
  users     WorkspaceUser[]
  projects  Project[]
  
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  
  @@index([ownerId])
}

model WorkspaceUser {
  id          String    @id @default(cuid())
  userId      String
  workspaceId String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime  @default(now())
  
  @@unique([userId, workspaceId])
  @@index([userId])
  @@index([workspaceId])
}

model Project {
  id          String         @id @default(cuid())
  name        String
  description String?
  status      ProjectStatus  @default(Active)
  priority    Priority       @default(Medium)
  progress    Int            @default(0) // 0-100
  startDate   DateTime
  endDate     DateTime
  
  workspaceId String
  workspace   Workspace      @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  leadId      String
  lead        User           @relation("ProjectLead", fields: [leadId], references: [id], onDelete: Cascade)
  
  // Relations
  users       ProjectUser[]
  tasks       Task[]
  files       FileAsset[]
  comments    Comment[]
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([workspaceId])
  @@index([leadId])
}

model ProjectUser {
  id        String    @id @default(cuid())
  userId    String
  projectId String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  project   Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  createdAt DateTime  @default(now())
  
  @@unique([userId, projectId])
  @@index([userId])
  @@index([projectId])
}

model Task {
  id          String      @id @default(cuid())
  title       String
  description String?
  status      TaskStatus  @default(TODO)
  type        TaskType    @default(TASK)
  priority    Priority    @default(Medium)
  dueDate     DateTime?
  
  projectId   String
  project     Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  assigneeId  String
  assignee    User        @relation("TaskAssignee", fields: [assigneeId], references: [id], onDelete: Cascade)
  
  // Relations
  files       FileAsset[]
  comments    Comment[]
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  @@index([projectId])
  @@index([assigneeId])
}

model FileAsset {
  id        String    @id @default(cuid())
  name      String
  size      String    // Store as string (e.g., "2.5 MB")
  type      String    // MIME type
  url       String
  
  projectId String
  project   Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  taskId    String?
  task      Task?     @relation(fields: [taskId], references: [id], onDelete: SetNull)
  
  uploadedById String
  uploadedBy   User    @relation("FileUploader", fields: [uploadedById], references: [id], onDelete: Cascade)
  
  createdAt DateTime  @default(now())
  
  @@index([projectId])
  @@index([taskId])
  @@index([uploadedById])
}

model Comment {
  id        String    @id @default(cuid())
  content   String
  
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  projectId String?
  project   Project?  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  taskId    String?
  task      Task?     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  
  @@index([userId])
  @@index([projectId])
  @@index([taskId])
}

// Enums
enum UserRole {
  ADMIN
  MEMBER
}

enum ProjectStatus {
  Active
  Planning
  Completed
  OnHold
  Cancelled
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
}

enum TaskType {
  TASK
  BUG
  FEATURE
  IMPROVEMENT
}

enum Priority {
  Low
  Medium
  High
}

